<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>New Tab</title>
    <style>
        :root { --bg: #1a1b1e; --accent: #8ab4f8; --text: #e8eaed; --panel: #202124; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; transition: background 0.3s; }
        
        body.theme-light { --bg: #f1f3f4; --text: #202124; --panel: #ffffff; --accent: #1a73e8; }
        
        h1 { font-size: 4rem; margin-bottom: 20px; font-weight: 300; letter-spacing: -2px; }
        
        /* Search Container */
        .search-container { width: 600px; max-width: 90%; position: relative; z-index: 10; }
        .search-box { width: 100%; background: var(--panel); border-radius: 30px; padding: 12px 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; align-items: center; box-sizing: border-box; transition: transform 0.2s, box-shadow 0.2s; }
        .search-box.open { border-radius: 24px 24px 0 0; box-shadow: 0 4px 5px rgba(0,0,0,0.1); }
        input { flex: 1; background: transparent; border: none; font-size: 18px; color: var(--text); outline: none; margin-left: 10px; }
        
        /* Suggestions */
        .suggestions { position: absolute; top: 100%; left: 0; right: 0; background: var(--panel); border-top: 1px solid #333; border-radius: 0 0 24px 24px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); display: none; flex-direction: column; overflow: hidden; }
        body.theme-light .suggestions { border-top: 1px solid #ddd; }
        .suggestion-item { padding: 10px 24px; cursor: pointer; display: flex; align-items: center; }
        .suggestion-item:hover { background-color: rgba(138, 180, 248, 0.1); }
        .suggestion-item svg { margin-right: 15px; opacity: 0.5; width: 16px; height: 16px; }

        /* Widgets */
        .widgets { margin-top: 60px; display: flex; gap: 20px; z-index: 1; }
        .widget { background: var(--panel); padding: 15px 25px; border-radius: 16px; min-width: 140px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .widget h3 { margin: 0; font-size: 14px; opacity: 0.7; }
        .widget .value { font-size: 24px; font-weight: bold; color: var(--accent); margin-top: 5px; }
        
        .blob { position: absolute; width: 600px; height: 600px; background: radial-gradient(circle, var(--accent) 0%, transparent 70%); opacity: 0.05; z-index: -1; border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); }
    
        /* Shortcuts Grid */
        .shortcuts-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; width: 560px; justify-items: center; margin-top: 30px; }
        .shortcut-item { display: flex; flex-direction: column; align-items: center; width: 112px; cursor: pointer; padding: 10px; border-radius: 8px; transition: background 0.2s; text-decoration: none; color: inherit; position: relative; }
        .shortcut-item:hover { background: rgba(255,255,255,0.1); }

        .icon-circle { width: 48px; height: 48px; background: var(--panel); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); overflow: hidden; }
        .icon-circle img { width: 24px; height: 24px; border-radius: 4px; }
        .shortcut-name { font-size: 12px; text-align: center; width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: var(--panel); padding: 24px; border-radius: 12px; width: 320px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); border: 1px solid #444; }
        .modal h2 { margin: 0 0 20px 0; font-size: 18px; font-weight: 500; }
        .modal input { width: 100%; background: #303134; border: 1px solid #444; padding: 10px 14px; border-radius: 6px; margin-bottom: 12px; font-size: 14px; margin-left: 0; box-sizing: border-box; color: white; }
        .modal-btns { display: flex; justify-content: flex-end; gap: 8px; }
        .btn { padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; font-size: 13px; font-weight: 500; }
        .btn-primary { background: var(--accent); color: #1a1b1e; }
        .btn-ghost { background: transparent; color: var(--accent); }

        /* Context Menu */
        .context-menu { position: fixed; background: #292a2d; border: 1px solid #444; border-radius: 4px; padding: 4px 0; min-width: 120px; display: none; z-index: 2000; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .context-item { padding: 8px 12px; font-size: 13px; cursor: pointer; color: var(--text); }
        .context-item:hover { background: #3c4043; }
        .context-item.delete { color: #e06c75; }

        .incognito-badge {
            border: 1px solid #333;
            background: #25222b;
            color: #a142f4;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            margin-bottom: 20px;
            display: none; /* Hidden by default */
            align-items: center;
            gap: 8px;
        }
    </style>
</head>
<body class="theme-dark">
    <div class="blob"></div>
    <div class="incognito-badge" id="incognito-badge">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M2 12h20M9.5 12l-2-6 3.5-3 3.5 3-2 6"></path> <circle cx="6" cy="15" r="3"></circle>
            <circle cx="18" cy="15" r="3"></circle>
        </svg>
        Incognito Mode
    </div>
    <h1>Zyro Browser</h1>
    
    <div class="search-container">
        <div class="search-box" id="sb">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <input type="text" id="search" placeholder="Search the web..." autocomplete="off" autofocus>
        </div>
        <div class="suggestions" id="suggestions"></div>
    </div>

    <div class="shortcuts-grid" id="shortcuts-grid">
        <div class="shortcut-item" onclick="openShortcutModal()">
            <div class="icon-circle add-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </div>
            <div class="shortcut-name">Add shortcut</div>
        </div>
    </div>

    <div class="widgets">
        <div class="widget"> <h3>CPU Usage</h3> <div class="value" id="cpu-val">0%</div> </div>
        <div class="widget"> <h3>RAM Usage</h3> <div class="value" id="ram-val">0 GB</div> </div>
    </div>

    <div class="modal-overlay" id="shortcut-modal">
        <div class="modal">
            <h2 id="modal-title">Add Shortcut</h2>
            <input type="text" id="shortcut-name-input" placeholder="Name">
            <input type="text" id="shortcut-url-input" placeholder="URL (e.g. google.com)">
            <div class="modal-btns">
                <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveShortcutModal()">Done</button>
            </div>
        </div>
    </div>

    <div id="shortcut-menu" class="context-menu">
        <div class="context-item" id="menu-edit">Edit</div>
        <div class="context-item delete" id="menu-delete">Delete</div>
    </div>

    <script>
        const searchInput = document.getElementById('search');
        const suggestBox = document.getElementById('suggestions');
        const searchBox = document.getElementById('sb');
        let debounceTimer;

        // --- Search Logic ---
        function doSearch(query) {
            if(query) window.webkit.messageHandlers.zyro.postMessage(JSON.stringify({ type: 'search', query: query }));
        }

        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') doSearch(searchInput.value);
        });

        searchInput.addEventListener('input', () => {
            const query = searchInput.value;
            clearTimeout(debounceTimer);
            if (query.length < 2) { hideSuggestions(); return; }
            debounceTimer = setTimeout(() => {
                window.webkit.messageHandlers.zyro.postMessage(JSON.stringify({ type: 'get_suggestions', query: query }));
            }, 200);
        });
        
        function renderSuggestions(items) {
            suggestBox.innerHTML = '';
            if (!items || items.length === 0) { hideSuggestions(); return; }

            items.forEach(rawItem => {
                let text = rawItem;
                let isHistory = false;
                if (text.startsWith("[H] ")) { isHistory = true; text = text.substring(4); }

                const div = document.createElement('div');
                div.className = 'suggestion-item';
                const icon = isHistory 
                    ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>'
                    : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>';

                div.innerHTML = `${icon}<span>${text}</span>`;
                div.onclick = () => doSearch(text);
                suggestBox.appendChild(div);
            });
            showSuggestions();
        }

        function showSuggestions() { suggestBox.style.display = 'flex'; searchBox.classList.add('open'); }
        function hideSuggestions() { suggestBox.style.display = 'none'; searchBox.classList.remove('open'); }

        document.addEventListener('click', (e) => {
            if (!document.querySelector('.search-container').contains(e.target)) hideSuggestions();
            // Also hide context menu if clicked elsewhere
            if (document.getElementById('shortcut-menu').style.display === 'block') {
                 document.getElementById('shortcut-menu').style.display = 'none';
            }
        });

        // --- Stats & Theme ---
        function setTheme(themeName) { document.body.className = 'theme-' + themeName; }
        function updateStats(cpu, ram) {
            document.getElementById('cpu-val').innerText = cpu + "%";
            document.getElementById('ram-val').innerText = ram;
        }

        // --- Shortcut Logic ---
        let editingIndex = -1;
        let selectedShortcutIndex = -1;

        function openShortcutModal(index = -1) {
            editingIndex = index;
            const modal = document.getElementById('shortcut-modal');
            const nameIn = document.getElementById('shortcut-name-input');
            const urlIn = document.getElementById('shortcut-url-input');
            const title = document.getElementById('modal-title');
            
            if (index === -1) {
                title.innerText = "Add Shortcut";
                nameIn.value = ''; urlIn.value = '';
            } else {
                title.innerText = "Edit Shortcut";
                // We'll fill this better if we passed the data, 
                // for now the user can just re-type or we use a global list in future.
            }
            modal.style.display = 'flex';
            nameIn.focus();
            
            // Hide context menu if it was open
            document.getElementById('shortcut-menu').style.display = 'none';
        }

        function closeModal() {
            document.getElementById('shortcut-modal').style.display = 'none';
        }

        function saveShortcutModal() {
            const name = document.getElementById('shortcut-name-input').value.trim();
            let url = document.getElementById('shortcut-url-input').value.trim();
            
            if (!name || !url) { alert("Please fill in both fields."); return; }
            if (!url.startsWith('http://') && !url.startsWith('https://')) url = 'https://' + url;

            const type = editingIndex === -1 ? 'add_shortcut' : 'edit_shortcut';
            const msg = { type: type, name: name, url: url };
            if (editingIndex !== -1) msg.index = editingIndex;
            
            window.webkit.messageHandlers.zyro.postMessage(JSON.stringify(msg));
            closeModal();
            
            // Refresh Grid
            setTimeout(() => {
                window.webkit.messageHandlers.zyro.postMessage(JSON.stringify({ type: 'get_shortcuts' }));
            }, 50);
        }

        function renderShortcuts(list) {
            const grid = document.getElementById('shortcuts-grid');
            grid.innerHTML = ''; 
            
            list.forEach((s, index) => {
                const item = document.createElement('div');
                item.className = 'shortcut-item';
                
                // Left Click: Navigate
                item.onclick = (e) => {
                     // Prevent firing if we just closed context menu
                     if(document.getElementById('shortcut-menu').style.display === 'block') return;
                     window.location.href = s.url;
                };

                // Right Click: Menu
                item.oncontextmenu = (e) => {
                    e.preventDefault();
                    e.stopPropagation(); // Stop bubbling
                    showContextMenu(e.clientX, e.clientY, index);
                };

                const iconUrl = `https://www.google.com/s2/favicons?sz=64&domain=${new URL(s.url).hostname}`;
                const circle = document.createElement('div');
                circle.className = 'icon-circle';
                
                const img = document.createElement('img');
                img.src = iconUrl;
                img.crossOrigin = "Anonymous";
                extractColor(img, circle);

                circle.appendChild(img);
                item.appendChild(circle);
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'shortcut-name';
                nameDiv.innerText = s.name;
                item.appendChild(nameDiv);

                grid.appendChild(item);
            });

            // Add Button (Always last)
            const addBtn = document.createElement('div');
            addBtn.className = 'shortcut-item';
            addBtn.onclick = () => openShortcutModal();
            addBtn.innerHTML = `
                <div class="icon-circle"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></div>
                <div class="shortcut-name">Add shortcut</div>
            `;
            grid.appendChild(addBtn);
        }

        function showContextMenu(x, y, index) {
            const menu = document.getElementById('shortcut-menu');
            selectedShortcutIndex = index;
            menu.style.display = 'block';
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
        }

        function extractColor(imgElement, circleElement) {
            imgElement.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 1; canvas.height = 1;
                ctx.drawImage(imgElement, 0, 0, 1, 1);
                const [r, g, b] = ctx.getImageData(0, 0, 1, 1).data;
                circleElement.style.backgroundColor = `rgba(${r}, ${g}, ${b}, 0.2)`;
                circleElement.style.border = `1px solid rgba(${r}, ${g}, ${b}, 0.4)`;
            };
            if (imgElement.complete) imgElement.onload();
        }

        // --- Context Menu Actions ---
        document.getElementById('menu-delete').onclick = () => {
            if (confirm("Delete this shortcut?")) {
                window.webkit.messageHandlers.zyro.postMessage(JSON.stringify({
                    type: 'delete_shortcut', index: selectedShortcutIndex
                }));
                document.getElementById('shortcut-menu').style.display = 'none';
                setTimeout(() => window.webkit.messageHandlers.zyro.postMessage(JSON.stringify({ type: 'get_shortcuts' })), 50);
            }
        };

        document.getElementById('menu-edit').onclick = () => {
             openShortcutModal(selectedShortcutIndex);
        };

        function setIncognitoMode(isIncognito) {
            if (isIncognito) {
                document.getElementById('incognito-badge').style.display = 'flex';
                // Optional: Hide widgets or shortcuts grid if you want a cleaner look
                document.getElementById('shortcuts-grid').style.display = 'none';
                document.querySelector('.widgets').style.display = 'none';
            }
        }

        window.onload = () => {
            window.webkit.messageHandlers.zyro.postMessage(JSON.stringify({ type: 'get_theme' }));
            
            window.webkit.messageHandlers.zyro.postMessage(JSON.stringify({ type: 'get_incognito_status' }));
            
            window.webkit.messageHandlers.zyro.postMessage(JSON.stringify({ type: 'get_shortcuts' }));
        }
    </script>
</body>
</html>